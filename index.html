import React, { useState, useEffect } from 'react';

// ========================================================
// BANCO DE PREGUNTAS (AGREGA MÁS HASTA 60)
// ========================================================
const QUESTION_BANK = [
  {
    theme: "Historia de la tecnología",
    question: "¿Quién es considerado el padre de la computación?",
    options: ["Alan Turing", "Bill Gates", "Steve Jobs", "Ada Lovelace"],
    answer: "Alan Turing",
    hint: "Descifró Enigma y formalizó las ideas de los algoritmos."
  },
  {
    theme: "Redes",
    question: "¿Qué protocolo se utiliza mayormente para transferir archivos?",
    options: ["FTP", "HTTP", "SMTP", "SSH"],
    answer: "FTP",
    hint: "Sus siglas se refieren a 'File Transfer Protocol'."
  },
  {
    theme: "Hardware",
    question: "¿Cuál componente es el 'cerebro' del computador?",
    options: ["RAM", "CPU", "SSD", "GPU"],
    answer: "CPU",
    hint: "Ejecuta instrucciones de todos los programas."
  },
  {
    theme: "Software",
    question: "¿Cuál es el sistema operativo de código abierto más popular?",
    options: ["Windows", "Linux", "MacOS", "ChromeOS"],
    answer: "Linux",
    hint: "Su mascota es un pingüino llamado Tux."
  },
  {
    theme: "IA en Cyberpunk",
    question: "¿Qué película popularizó el concepto de IA rebelde en ambiente cyberpunk?",
    options: ["Blade Runner", "Matrix", "Akira", "Ghost in the Shell"],
    answer: "Blade Runner",
    hint: "Basada en una novela de Philip K. Dick."
  },
  // ...Agrega hasta 60 preguntas siguiendo el mismo formato
];

// ========================================================
// FUNCION UTILIDAD PARA TOMAR 20 PREGUNTAS ALEATORIAS
// ========================================================
function pickRandom(arr, num) {
  let copy = [...arr];
  for (let i = copy.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy.slice(0, num);
}

// ========================================================
// COMPONENTE PRINCIPAL
// ========================================================
function App() {
  // Estado global
  const [showQuiz, setShowQuiz] = useState(false);
  const [questions, setQuestions] = useState([]);
  const [answers, setAnswers] = useState([]);
  const [current, setCurrent] = useState(0);
  const [showHint, setShowHint] = useState([]);
  const [fiftyUsed, setFiftyUsed] = useState([]);
  const [fiftyCount, setFiftyCount] = useState(0);
  const [optionLim, setOptionLim] = useState([]);
  const [startTime, setStartTime] = useState(0);
  const [elapsed, setElapsed] = useState(0);
  const [finished, setFinished] = useState(false);
  const [score, setScore] = useState(0);
  const [attempts, setAttempts] = useState(() => Number(localStorage.getItem("cyberAttempts")||0));

  // ===== Reiniciar cuestionario =====
  function startQuiz() {
    setQuestions(pickRandom(QUESTION_BANK, 20));
    setAnswers(Array(20).fill(null));
    setCurrent(0);
    setShowHint(Array(20).fill(false));
    setFiftyUsed(Array(20).fill(false));
    setFiftyCount(0);
    setOptionLim(Array(20).fill(null));
    setStartTime(Date.now());
    setFinished(false);
    setScore(0);
    setElapsed(0);
    setShowQuiz(true);
  }

  // ===== Cronómetro =====
  useEffect(() => {
    if (!showQuiz || finished) return;
    const timer = setInterval(() => {
      setElapsed(Math.floor((Date.now() - startTime) / 1000));
    }, 1000);
    return () => clearInterval(timer);
  }, [showQuiz, startTime, finished]);

  // ===== Manejar respuesta seleccionada =====
  function handleSelect(opt) {
    const copy = [...answers];
    copy[current] = opt;
    setAnswers(copy);
  }

  // ===== Mostrar pista (JARVIS) =====
  function handleHint() {
    const copy = [...showHint];
    copy[current] = true;
    setShowHint(copy);
  }

  // ===== Botón 50/50 =====
  function handleFifty() {
    if (fiftyCount >= 5 || fiftyUsed[current]) return;
    const q = questions[current];
    // Elimina dos incorrectas (deja correcta y una incorrecta)
    const wrongs = q.options.filter(o => o !== q.answer);
    const show = [q.answer, wrongs[Math.floor(Math.random()*wrongs.length)]];
    setOptionLim(opts => {
      const n = [...opts];
      n[current] = show;
      return n;
    });
    const fCopy = [...fiftyUsed]; fCopy[current] = true;
    setFiftyUsed(fCopy);
    setFiftyCount(c=>c+1);
  }

  // ===== Navegación =====
  function prev() { setCurrent(curr=>curr > 0 ? curr-1 : curr); }
  function next() { setCurrent(curr=>curr < 19 ? curr+1 : curr); }

  // ===== Finalizar y puntuar =====
  function finishQuiz() {
    const pts = questions.reduce((acc, q, idx) => (answers[idx] === q.answer ? acc+1 : acc), 0);
    setScore(pts);
    setFinished(true);
    setAttempts(a=>{
      localStorage.setItem("cyberAttempts",a+1);
      return a+1;
    });
  }

  // ===== UI Intro =====
  if (!showQuiz) return (
    <div style={{padding:"2rem", fontFamily:"monospace", background:"#202038", color:"aqua", borderRadius:"1rem", maxWidth:560, margin:"2rem auto", boxShadow:"0 0 2rem #0ff"}}>
      <h1 style={{fontWeight:700, fontSize:"2rem"}}>NeonTech Challenge</h1>
      <p><b>Autor:</b> Samuel Galvis</p>
      <p>
        <b>Propósito:</b> Evaluar tus conocimientos sobre tecnología, hardware, software, redes, inteligencia artificial y cultura cyberpunk mediante preguntas interactivas.<br />
        <b>Temáticas:</b> Historia tecnológica, hardware, redes, software, IA en cyberpunk.<br />
      </p>
      <b>Resumen:</b>
      <ul>
        <li>20 preguntas aleatorias de un banco de hasta 60.</li>
        <li>Ayuda futurista de JARVIS: pistas y opción 50/50 (máximo 5 usos).</li>
        <li>Retroalimentación y nota al final.</li>
        <li>Botón siguiente/anterior, cronómetro, contador de intentos.</li>
      </ul>
      <p style={{color:"#7fffd4"}}>¿Listo para conectar tu mente al flujo digital?</p>
      <button onClick={startQuiz} style={{padding:"1em", background:"#0ff", color:"#222", fontWeight:"bold", fontSize:"1.2em", borderRadius:"10px", cursor:"pointer"}}>
        INICIAR CUESTIONARIO
      </button>
      <div style={{marginTop:"2em"}}>Intentos realizados: <b>{attempts}</b></div>
    </div>
  );

  // ===== UI Quiz =====
  if (!questions.length) return <div>Cargando preguntas...</div>;
  if (finished) {
    let feedback = "¡Buen esfuerzo!";
    if (score === 20) feedback = "¡Excelente, eres todo un ciberasceta!";
    else if (score >= 15) feedback = "Muy buen desempeño, tu nivel es avanzado.";
    else if (score < 10) feedback = "Revisa los temas y mejora tu maestría digital.";
    return (
      <div style={{background:"#202038", color:"aqua", borderRadius:"1rem", padding:"2rem", maxWidth:500, margin:"2rem auto"}}>
        <h2>Resultados</h2>
        <p>Nota: <b>{score} de 20</b></p>
        <p>{feedback}</p>
        <p>Tiempo: <b>{elapsed} segundos</b></p>
        <p>Intentos realizados: <b>{attempts}</b></p>
        <button onClick={startQuiz} style={{marginTop:"1em", padding:"1em", background:"aqua", borderRadius:"10px", color:"#202038", fontWeight:"bold", fontSize:"1em"}}>VOLVER A INTENTAR</button>
      </div>
    );
  }

  // Pregunta actual
  const q = questions[current];
  const showOpts = optionLim[current] || q.options;

  return (
    <div style={{
      background:"#202038", color:"aqua", borderRadius:"1rem",
      padding:"2rem", maxWidth:560, margin:"2rem auto", boxShadow:"0 0 1.5rem #2ff"
    }}>
      <div style={{display:"flex", justifyContent:"space-between", alignItems:"center"}}>
        <div>Intentos: <b>{attempts}</b></div>
        <div>Tiempo: <b>{elapsed}s</b></div>
      </div>
      <hr />
      <h2 style={{margin:"0 0 0.6em 0"}}>{q.theme}</h2>
      <p style={{fontWeight:"bold", fontSize:"1.2em"}}>{q.question}</p>
      <div style={{marginTop:"1em"}}>
        {showOpts.map(opt => (
          <label key={opt} style={{
            display:"block", margin:"0.5em 0", cursor:"pointer",
            background:answers[current]===opt ? "#09b" : "#232370", color:"aqua",
            borderRadius:"6px", padding:"0.6em", border:"1px solid #07ffea"
          }}>
            <input
              type="radio"
              value={opt}
              checked={answers[current]===opt}
              onChange={()=>handleSelect(opt)}
              style={{marginRight:"0.6em"}}
            />
            {opt}
          </label>
        ))}
      </div>
      {/* Asistente JARVIS y botones */}
      <div style={{display:"flex", gap:"1em", margin:"1em 0"}}>
        <button onClick={handleHint} disabled={showHint[current]} style={{
          background:"#19ebac", color:"#222", borderRadius:"5px", fontWeight:700, padding:"0.4em 0.7em"
        }}>JARVIS: Pista</button>
        <button onClick={handleFifty} disabled={fiftyCount>=5 || fiftyUsed[current]} style={{
          background:"#5a00ff", color:"#fff", borderRadius:"5px", fontWeight:700, padding:"0.4em 0.7em"
        }}>50/50 ({5-fiftyCount} restantes)</button>
      </div>
      {/* Mostrar pista */}
      {showHint[current] &&
        <div style={{background:"#111", color:"#7fffd4", borderRadius:"6px", padding:"1em", margin:"1em 0"}}>
          <b>JARVIS dice:</b> {q.hint}
        </div>
      }
      <div style={{display:"flex", gap:"1em", marginTop:"1em"}}>
        <button onClick={prev} disabled={current===0} style={{padding:"0.7em", borderRadius:"6px", fontWeight:700}}>Anterior</button>
        <button onClick={next} disabled={current===19} style={{padding:"0.7em", borderRadius:"6px", fontWeight:700}}>Siguiente</button>
        <button
          onClick={finishQuiz}
          disabled={answers.includes(null)}
          style={{padding:"0.7em", borderRadius:"6px", background:"#0ff", color:"#202038", fontWeight:700}}
        >
          Finalizar
        </button>
      </div>
      <div style={{marginTop:"1em", color:"#aaa"}}>
        Pregunta {current+1} / 20 &nbsp; | &nbsp; 50/50 usados: <b>{fiftyCount}</b> / 5
      </div>
    </div>
  );
}

export default App;
